const CACHE_TEXT_KEY="CACHE_TEXT",CACHE_API_KEY="CACHE_API_KEY",CACHE_ENDPOINT_KEY="CACHE_ENDPOINT",CACHE_RATE_KEY="rate",CACHE_PITCH_KEY="pitch",CACHE_LANGUAGE_KEY="language",CACHE_VOICE_KEY="voice",CACHE_CHATGPTRESULTCACHE_KEY="chatGPTResultCache";let speakText="",chatGPTResultCache=new Map,RATE=1,PITCH=1,LANGUAGE="ja-JP",VOICE="",TEXT="",API_KEY="",ENDPOINT="https://api.openai.com/v1/chat/completions";function getCookie(e){return localStorage.getItem(e)}let voices=[];function populateVoiceList(){voices=speechSynthesis.getVoices(),voiceSelect.innerHTML="",voices.forEach((e=>{const t=document.createElement("option");t.value=e.name,t.textContent=`${e.name} (${e.lang})`,voiceSelect.appendChild(t)})),voiceSelect.value=VOICE}function setCookie(e,t){localStorage.setItem(e,t)}function initCache(){const e=getCookie("CACHE_TEXT"),t=getCookie(CACHE_API_KEY),n=getCookie("CACHE_ENDPOINT"),o=getCookie("rate"),c=getCookie("pitch"),a=getCookie("language"),i=getCookie("voice"),s=getCookie("chatGPTResultCache");s&&(chatGPTResultCache=new Map(Object.entries(JSON.parse(s)))),t&&(API_KEY=t),ENDPOINT=n||"https://api.openai.com/v1/chat/completions",e&&(TEXT=JSON.parse(e),setText(TEXT)),o&&(RATE=Number(o)),c&&(PITCH=Number(c)),a&&(LANGUAGE=a),i&&(VOICE=i),document.getElementById("keyInput").value=API_KEY,document.getElementById("apiInput").value=ENDPOINT,document.getElementById("rateInput").value=RATE,document.getElementById("pitchInput").value=PITCH,document.getElementById("languageSelect").value=LANGUAGE}function saveSetting(){const e=document.getElementById("keyInput"),t=document.getElementById("apiInput"),n=document.getElementById("rateInput"),o=document.getElementById("pitchInput"),c=document.getElementById("languageSelect");document.getElementById("voiceSelect");setCookie(CACHE_API_KEY,e.value),setCookie("CACHE_ENDPOINT",t.value?t.value:"https://api.openai.com/v1/chat/completions"),setCookie("rate",n.value),setCookie("pitch",o.value),setCookie("language",c.value)}function setText(e){for(var t=e,n="<h4>"+t.t+"</h4>",o=0;o<t.p.length;o++){splitTextByNewline(t.p[o]).forEach((function(e){n+="<p>";splitJapaneseText(e).forEach((function(e){n+="<span class='sentences'>";tokenizer.tokenize(e).forEach((e=>{n+=`<span>${e.surface_form}</span>`})),n+="</span>"})),n+="</p>"}))}document.getElementById("fiction_container").innerHTML=n;let c=document.getElementsByClassName("sentences");for(o=0;o<c.length;o++){let e=c[o],t=new Hammer.Manager(e),n=new Hammer.Tap({event:"doubletap",taps:2});t.add(n),t.on("doubletap",(function(t){actionOpened||(document.getElementById("myModal-Content").innerHTML="",document.getElementById("myModal").style.display="block",speakText=e.innerText,chatGPTResultCache.get(e.innerText)?document.getElementById("myModal-Content").innerHTML=chatGPTResultCache.get(e.innerText):callChatGPT(e.innerText))}))}return n}const messages=[{role:"system",content:"你是一个善于指导学生的日语专家，可以对学生的向你提问的日语内容，进行非常深入的洞察，分析和讲解，讲解的内容包含但不限于注音（使用平假名和罗马字）、知识拓展、语法例子（例子附上平假名、罗马字）、对提问内容进行语法的简单易懂的详尽讲解。"}];let chatGptResult="",chatGptHTMLResult="";const contentPattern=/"content":"(.*?)"}/;let waiting=!1;function ssePost(e,t,n,o,c,a,i){Object.keys(n).length>0&&(e+="?"+objectToQueryString(n)),fetch(e,{method:"POST",headers:t,body:o}).then((async e=>{if(!e.ok)return void i(new Error("Network response was not ok"));const t=e.body.getReader();let n="",o="";for(;;){const{done:e,value:a}=await t.read();if(e)break;const i=(new TextDecoder).decode(a);for(const e of i)if("\n"===e&&"\n"===o){const e=n.substring(0,n.length-1).split("\n"),t={};e.forEach((e=>{const n=e.indexOf(":");-1!==n&&(t[e.substring(0,n)]=e.substring(n+2))})),c(t),n=""}else o=e,n+=e}a()})).catch((e=>{i(e)}))}function getContent(e){const t=e.match(contentPattern);return t?t[1]:null}function addMessage(e,t){messages.push({role:e,content:t})}function callChatGPT(e){addMessage("user",`请帮我讲解${e}的用法`);let t="";chatGptResult="";const n=JSON.stringify({model:"gpt-4o-mini",messages:messages,max_tokens:5e3,stream:!0});ssePost(ENDPOINT,{"Content-Type":"application/json",Authorization:"Bearer "+API_KEY},{},n,(e=>{const n=getContent(e.data);if(n){chatGptResult+=n.replace("\\n"," \n ").replace("\\n"," \n ").replace("\n"," \n ");marked.parse(chatGptResult);const e=window.markdownit({html:!0,linkify:!0,breaks:!0,langPrefix:"language-",typographer:!0});t=e.render(chatGptResult);(new showdown.Converter).makeHtml(chatGptResult);document.getElementById("myModal-Content").innerHTML=t}}),(()=>{chatGPTResultCache.set(e,t);let n=Object.fromEntries(chatGPTResultCache);setCookie("chatGPTResultCache",JSON.stringify(n)),waiting=!1}),(e=>{console.log(e)}))}function splitTextByNewline(e){return e.split("\n").map((e=>e.trim()))}function splitJapaneseText(e){const t=/([^「」！？。]+[！？。])|(「[^」]*」)/g,n=[];let o;for(;null!==(o=t.exec(e));)o[1]?n.push(o[1].trim()):n.push(o[0].trim());return n}document.getElementById("fileInput").addEventListener("change",(function(e){const t=e.target.files[0];if(t&&"text/plain"===t.type){const e=new FileReader;e.onload=function(e){const n={t:t.name,p:[e.target.result]};console.log(n),TEXT=n,setCookie("CACHE_TEXT",JSON.stringify(n)),setText(TEXT)},e.readAsText(t)}else alert("请选择一个文本文件")}));const modals=document.querySelectorAll(".modal"),importFileModal=document.getElementById("importFileModal"),settingModal=document.getElementById("settingModal"),openImportModal=document.getElementById("openImportModal"),openSettingModal=document.getElementById("openSettingModal"),closeModalBtns=document.querySelectorAll(".close, .closeModalBtn");closeModalBtns.forEach((e=>{e.onclick=function(){modals.forEach((function(e){e.style.display="none"}))}})),openImportModal.onclick=function(){importFileModal.style.display="block"},openSettingModal.onclick=function(){settingModal.style.display="block"};const speakButton=document.getElementById("speakButton"),languageSelect=document.getElementById("languageSelect");speakButton.addEventListener("click",(()=>{const e=speakText,t=languageSelect.value,n=new SpeechSynthesisUtterance(e);n.lang=t,n.rate=RATE,n.pitch=PITCH,speechSynthesis.speak(n)}));let tokenizer=null,actionOpened=!1,chatGPTResult="";kuromoji.builder({dicPath:"dict"}).build((function(e,t){null!=e&&console.log(e),tokenizer=t,function(){"use strict";var e,t,n,o=(e="html5_reader_",{getBSONP:function(e,t){return $.jsonp({url:e,cache:!0,callback:"duokan_fiction_chapter",success:function(e){var n=$.base64.decode(e),o=decodeURIComponent(escape(n));t(o)}})},StorageGetter:function(t){return localStorage.getItem(e+t)},StorageSetter:function(t,n){return localStorage.setItem(e+t,n)}}),c={top_nav:$("#top_nav"),bottom_nav:$(".bottom-nav"),nav_pannel:$(".nav-pannel"),font_btn:$("#font_btn"),font_icon:$(".font-icon"),bk_container:$(".bk-container")},a=$(window),i=($(document),$("#fiction_container")),s=parseInt(o.StorageGetter("font_size"));s||(s=14),i.css("font-size",s);var l,r,u,d,p,m=o.StorageGetter("background_color");function g(e){return e.split("\n").map((e=>e.trim()))}function h(e){const t=/([^「」！？。]+[！？。])|(「[^」]*」)/g,n=[];let o;for(;null!==(o=t.exec(e));)o[1]?n.push(o[1].trim()):n.push(o[0].trim());return n}m||(m="#e9dfc7"),u=function(e){d((function(){p(l,(function(t){e&&e(t)}))}))},d=function(e){$.get("data/chapter.json",(function(t){l=o.StorageGetter("last_chapter_id"),r=t.chapters.length,console.log(r),null==l&&(l=t.chapters[1].chapter_id),e&&e()}),"json")},p=function(e,t){},t={init:u,prevChapter:function(e){1!=l&&(l-=1,o.StorageSetter("last_chapter_id",l),p(l,e))},nextChapter:function(e){4!=l&&(l+=1,o.StorageSetter("last_chapter_id",l),p(l,e))}},n=function(e){function t(e){for(var t=e,n="<h4>"+t.t+"</h4>",o=0;o<t.p.length;o++)g(t.p[o]).forEach((function(e){n+="<p>",h(e).forEach((function(e){n+="<span class='sentences'>",tokenizer.tokenize(e).forEach((e=>{n+=`<span>${e.surface_form}</span>`})),n+="</span>"})),n+="</p>"}));return n}return function(n){e.html(t(n)),e.css("background_color",m);let o=document.getElementsByClassName("sentences");for(var c=0;c<o.length;c++){let e=o[c],t=new Hammer.Manager(e),n=new Hammer.Tap({event:"doubletap",taps:2});t.add(n),t.on("doubletap",(function(t){actionOpened||(document.getElementById("myModal-Content").innerHTML="",document.getElementById("myModal").style.display="block",p(e.innerText))}))}const a=[{role:"system",content:"你是一个善于指导学生的日语专家，可以对学生的向你提问的日语内容，进行非常深入的洞察，分析和讲解，讲解的内容包含但不限于注音（使用平假名和罗马字）、知识拓展、语法例子（例子附上平假名、罗马字）、对提问内容进行语法的简单易懂的详尽讲解。"}];let i="";const s=/"content":"(.*?)"}/;let l=!1;function r(e,t,n,o,c,a,i){Object.keys(n).length>0&&(e+="?"+objectToQueryString(n)),fetch(e,{method:"POST",headers:t,body:o}).then((async e=>{if(!e.ok)return void i(new Error("Network response was not ok"));const t=e.body.getReader();let n="",o="";for(;;){const{done:e,value:a}=await t.read();if(e)break;const i=(new TextDecoder).decode(a);for(const e of i)if("\n"===e&&"\n"===o){const e=n.substring(0,n.length-1).split("\n"),t={};e.forEach((e=>{const n=e.indexOf(":");-1!==n&&(t[e.substring(0,n)]=e.substring(n+2))})),c(t),n=""}else o=e,n+=e}a()})).catch((e=>{i(e)}))}function u(e){const t=e.match(s);return t?t[1]:null}function d(e,t){a.push({role:e,content:t})}function p(e){d("user",`请帮我讲解${e}的用法`),i="";const t=JSON.stringify({model:"gpt-4o-mini",messages:a,stream:!0});r(ENDPOINT,{"Content-Type":"application/json",Authorization:"Bearer "+API_KEY},{},t,(e=>{const t=u(e.data);if(t){i+=t.replace("\\n"," \n ").replace("\\n"," \n ").replace("\n"," \n "),marked.parse(i);const e=window.markdownit({html:!0,linkify:!0,breaks:!0,langPrefix:"language-",typographer:!0}).render(i);(new showdown.Converter).makeHtml(i),document.getElementById("myModal-Content").innerHTML=e}}),(()=>{console.log(i),l=!1}),(e=>{console.log(e)}))}}}(i),t.init((function(e){n(e)})),$("#catalog_btn").click((function(){location.href="http://dushu.xiaomi.com/fiction/chapter/306450"})),$("#action_mid").click((function(){"none"==c.top_nav.css("display")?(c.top_nav.show(),c.bottom_nav.show(),actionOpened=!0,$("#myModal").css("display","none")):(c.bottom_nav.hide(),c.top_nav.hide(),c.nav_pannel.hide(),c.font_icon.removeClass("icon-active"),actionOpened=!1)})),c.font_btn.click((function(){"none"==c.nav_pannel.css("display")?(c.nav_pannel.show(),c.font_icon.addClass("icon-active")):(c.nav_pannel.hide(),c.font_icon.removeClass("icon-active"))})),$("#night_day_switch_btn").click((function(){"none"==$("#day_icon").css("display")?($("#day_icon").show(),$("#night_icon").hide(),i.css("background-color","rgba(0, 0, 0, 0.8)"),c.bk_container.html(""),$(".bk-container:last-child").html('<div class="bk-container-active"></div>')):($("#day_icon").hide(),$("#night_icon").show(),i.css("background-color","#e9dfc7"),c.bk_container.html(""),$(".bk-container:first-of-type").html('<div class="bk-container-active"></div>'))})),c.bk_container.click((function(){c.bk_container.html(""),$(this).html('<div class="bk-container-active"></div>'),m=$(this).css("background-color"),i.css("background-color",m),o.StorageSetter("background_color",m)})),$("#large-font").click((function(){s>=20||(s+=1,i.css("font-size",s),o.StorageSetter("font_size",s))})),$("#small-font").click((function(){s<=12||(s-=1,i.css("font-size",s),o.StorageSetter("font_size",s))})),a.scroll((function(){c.bottom_nav.hide(),c.top_nav.hide(),c.nav_pannel.hide(),c.font_icon.removeClass("icon-active")})),$("#prev_btn").click((function(){t.prevChapter((function(e){n(e)})),a.scrollTop(0)})),$("#next_btn").click((function(){t.nextChapter((function(e){n(e)})),a.scrollTop(0)}))}(),initCache(),speechSynthesis.onvoiceschanged=populateVoiceList}));